<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
  <script type="text/javascript" src="Sprite.js"></script>
  <link rel="stylesheet" href="styles/style.css"/>
  <style type="text/css">
     canvas{
       position = absolute;
       top = 0px;
       bottom = 0px;
       left = 0px;
       rigth = 0px;
       margin = auto;
     }
  
  
  </style>
  <title>Minha engine</title>
</head>
<body>
  <script>
    //variaveis do jogo
    var canvas,ctx, ALTURA, LARGURA, frames = 0, maxPulos = 40, velocidade = 4, velocidade2 = 8, velocidade3 = 10,
    estadoActual, record, img,
    
    estados = {
      jogar: 0,
      jogando: 1,
      perdeu: 2
    },
    
    chao = {
      y: 550,
      altura: 50,
      cor: "#eBda7B",
      
      
      desenha: function(){
        ctx.fillStyle = this.cor;
        ctx.fillRect(0, this.y, LARGURA, this.altura);
      
      }
    
    },
    
    bloco = {
      x: 50,
      y: 0,
      altura: 50,
      largura: 50,
      cor: "#ff9239",
      gravidade: 1.56,
      velocidade: 0,
      forcaDoPulo: 24.6,
      qntPulos: 0,
      score: 0,
      
      actualiza: function(){
        this.velocidade += this.gravidade;
        this.y += this.velocidade;
      
        if(this.y > chao.y - this.altura && estadoActual != estados.perdeu){
           this.y = chao.y - this.altura;
           this.qntPulos = 0;
           this.velocidade = 0;
        }
      },
      
      pula: function(){
       if(this.qntPulos < maxPulos) {
          this.velocidade = -this.forcaDoPulo;
          this.qntPulos++;
          }
      },
      
      reset: function(){
         this.velocidade = 0;
         this.y = 0;
         
         if(this.score > record){
           localStorage.setItem(record, this.score);
           record = this.score;
         }
         
         this.score = 0;
      },
      
      desenha: function(){
         ctx.fillStyle = this.cor;
         ctx.fillRect(this.x, this.y, this.largura, this.altura);
      
      }
    
    },
    
    obstaculos = {
      _obs: [],
      cores: ["#ffbc1c", "#ff1c1c", "#ff85e1", "#52a7ff", "#78ff5d"],
      tempoInsere: 0,
      
      insere: function(){
        this._obs.push({
          x: LARGURA,
          //largura: 30 + Math.floor(21 * Math.random()),
          largura: 50,
          altura: 30 + Math.floor(100 * Math.random()),
          cor: this.cores[Math.floor(5 * Math.random())],
        });
      
         this.tempoInsere = 30 + Math.floor(81 * Math.random());
      },
      
      actualiza: function(){
      
         if(this.tempoInsere == 0)
           this.insere();
          else 
           this.tempoInsere --;
         
      
        for (var i = 0, tam = this._obs.length; i < tam; i++){
          var obs = this._obs [i];
          
         if(bloco.score <= 15) 
          obs.x -= velocidade;
          
         else if(bloco.score > 15 && bloco.score < 30)
           obs.x -= velocidade2;
         
         else
           obs.x -= velocidade3;
          
          if(bloco.x < obs.x + obs.largura && bloco.x + bloco.largura >= obs.x && bloco.y + bloco.altura >= chao.y - obs.altura){
             estadoActual = estados.perdeu;
          }
          
          else if(obs.x == 0){
            bloco.score++;
          }
          
          else if (obs.x <= -obs.LARGURA){
             this._obs.splice(i, 1);
             tam--;
             i--;
          }
        }
      
      },
      
      limpa: function(){
        this._obs = [];
      },
      
      desenha: function(){
        for (var i = 0, tam = this._obs.length; i < tam; i++){
          var obs = this._obs[i];
          ctx.fillStyle = obs.cor;
          ctx.fillRect(obs.x, chao.y - obs.altura, obs.largura, obs.altura);
        }
      
      },
    
    };
  
  
    function clique(event) {
     if(estadoActual == estados.jogando)
       bloco.pula();
       
     else if(estadoActual == estados.jogar){
       estadoActual = estados.jogando;
     }
     
     else if(estadoActual == estados.perdeu){
       estadoActual = estados.jogar;
       obstaculos.limpa();
       bloco.reset();
     }
    
    }
    
    function main() {
      ALTURA = window.innerHeight;
      LARGURA = window.innerWidth;
      
      if(LARGURA >= 500){
         LARGURA = 600;
         ALTURA = 600;
      }
    canvas = document.createElement("canvas");
    canvas.width = LARGURA;
    canvas.height = ALTURA;
    canvas.style.border = "1px solid #000";
    
    ctx = canvas.getContext("2d");
    document.body.appendChild(canvas);
    
    document.addEventListener("mousedown", clique);
    
    estadoActual = estados.jogar;
    record = localStorage.getItem("record");
    
    if(record == null)
      record = 0;
      
    img = new Image();
    img.src = "";
    
    
    roda();
    
    }
    
    function roda(){
      actualiza();
      desenha();
      
      window.requestAnimationFrame(roda);
    
    }
    
    function actualiza() {
      frames++;
      
      bloco.actualiza();
      
      if(estadoActual == estados.jogando){
          obstaculos.actualiza();
      }
    }
    
    function desenha() {
    ctx.fillStyle = "#80daff"
    ctx.fillRect(0, 0, LARGURA, ALTURA);
    
    ctx.fillStyle = "#fff";
    ctx.font = "50px Arial";
    ctx.fillText(bloco.score, 30, 60);
    
    if(estadoActual == estados.jogar){
      ctx.fillStyle = "green";
      ctx.fillRect(LARGURA / 2 - 50, ALTURA / 2 - 50, 100, 100);
    
    
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.fillText("Play", LARGURA / 2 - 50, ALTURA / 2 + 12);
      
    } 
    
    else if (estadoActual == estados.perdeu){
    ctx.fillStyle = "red";
    ctx.fillRect(LARGURA / 2 - 50, ALTURA / 2 - 50, 100, 100);
    
    ctx.save();
    ctx.translate(LARGURA / 2, ALTURA / 2 );
    ctx.fillStyle = "#fff";
    
    if(bloco.score > record)
       ctx.fillText("Novo Record!", -150, -65);
       
    else if(bloco.score < 10)
       ctx.fillText("Record " + record, -99, -65);
       
    else if(boco.score >= 10 && bloco.score < 100)
      ctx.fillText("Record " + record, -112, -65);
      
    else 
      ctx.fillText("Record " + record, -125, -65);
     
     
    if(bloco.score < 10)
      ctx.fillText(bloco.score, -13, 19);
      
    else if(bloco.score >= 10 && bloco.score < 100)
      ctx.fillText(bloco.score, -26, 19);
      
    else
      ctx.fillText(bloco.score, -39, 19);
    
    ctx.restore();
    
    }
    
    else if (estadoActual == estados.jogando)
      obstaculos.desenha();
    
    chao.desenha();
    bloco.desenha();
    }
    
    
    //inicializa o jogo
    main()
  </script>
</body>
</html>